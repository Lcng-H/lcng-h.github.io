<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‹¼è±†è¾…åŠ©å·¥å…· V2.1</title>
    <link rel="shortcut icon" href="/image/favicon.png" type="image/png">
    <link rel="stylesheet" href="https://ajax.aspnetcdn.com/ajax/bootstrap/4.3.1/css/bootstrap.min.css">
    <style>
        body {
            margin: 0;
            overflow-x: hidden;
        }

        canvas {
            border: 1px solid #060606;
        }

        #mainContent {
            display: none;
        }

        .colorBlock {
            display: inline-block;
            width: 24px;
            height: 24px;
            text-align: center;
            line-height: 24px;
            margin: 2px;
            vertical-align: top;
            font: 11px monospace;
            border: 1px solid #060606;
        }

        .pointer {
            cursor: pointer;
        }

        .colorBlock.selected {
            border: 3px solid #ff0000;
        }

        td {
            text-align: center;
            vertical-align: middle;
        }

        .mask {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        a:hover {
            text-decoration: none;
        }
    </style>

    <script src="js/palette.v5.js"></script>
    <script src="https://ajax.aspnetcdn.com/ajax/jquery/jquery-3.4.1.min.js"></script>
    <script src="js/popper.min.js"></script>
    <script src='https://ajax.aspnetcdn.com/ajax/bootstrap/4.3.1/bootstrap.min.js'></script>
</head>

<body>
    <div class="card">
        <div class="h3 card-header">
            <label>æ‹¼è±†è¾…åŠ©å·¥å…· V2.1</label>
            <div class="float-right mx-2" class='align-top'>
                <img src='image/help.png' style='height: 2rem;' data-toggle="modal" data-target="#docModal"
                    title="å¸®åŠ©æ–‡æ¡£" />
<!--                <span class="h6">ä¸­æ–‡/<a href="/index-en.html">Eng</a></span>-->
                <span class="h6">ä¸­æ–‡</span>
            </div>
             <div class="float-right mx-2" class='align-top' style="margin: 0 2em 0 2em">
                <span class="h6">Modified By: 1cng</span>
            </div>
            <div class="float-right mx-2" class='align-top' style="margin: 0 2em 0 2em">
                <span class="h6">æœ€åæ›´æ–°æ—¶é—´ï¼š2025.10.21 v1 </span>
            </div>
        </div>
        <div class="card-body">
            <form>
                <div class="form-group">
                    <div class="row">
                        <label class="col-sm-2 col-form-label">é€‰æ‹©å›¾ç‰‡ï¼ˆå»ºè®®ä¸è¶…è¿‡3000x3000ï¼ŒPNGä¼˜å…ˆï¼‰ï¼š</label>
                        <div class="custom-file col-sm-4">
                            <input type="file" class="custom-file-input" id="imageChooser"
                                accept="image/png, image/jpeg, image/gif" />
                            <label class="custom-file-label" for="imageChooser"></label>
                        </div>
                        <div class="col-sm-6">
                            <div id="imageControlButtons" class="btn-group" role="group" aria-label="image controls" style="margin-left:0.5rem;">
                                <button type="button" class="btn btn-primary" id="processImageBtn" disabled>å¤„ç†å›¾ç‰‡</button>
                            </div>
                            <div id="imageWarning" class="text-warning small mt-1"></div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <div class="row">
                        <label class="col-sm-2 col-form-label">æ‹¼è±†å“ç‰Œï¼š</label>
                        <select id="paletteSelect" class="form-control col-sm-4">
                            <option value="mard" selected>Mard(é»„è±†è±†&å°èˆ)</option>
                            <option value="manman">æ¼«æ¼«</option>
<!--                            <option value="hama">Hama</option>-->
<!--                            <option value="perler">Perler 5mm</option>-->
<!--                            <option value="perler-mini">Perler mini 2.6mm</option>-->
<!--                            <option value="nabbi">Nabbi</option>-->
<!--                            <option value="artkal-s">Artkal S 5mm</option>-->
<!--                            <option value="artkal-r">Artkal R soft 5mm</option>-->
<!--                            <option value="artkal-c">Artkal C 2.6mm</option>-->
<!--                            <option value="artkal-a">Artkal A soft 2.6mm</option>-->
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <div class="row">
                        <label class="col-sm-2 col-form-label">å›¾å—å¤§å°ï¼š</label>
                        <select id="pieceSizeSelect" class="form-control col-sm-4">
                            <option value="20">20x20</option>
                            <option value="25">25x25</option>
                            <option value="30">30x30</option>
                            <option value="40" selected>40x40</option>
                            <option value="50">50x50</option>
                            <option value="100">100x100</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <div class="row">
                        <label class="col-sm-2 col-form-label">é¢œè‰²åŒ¹é…æ–¹å¼ï¼š</label>
                        <select id="colorDistanceSelect" class="form-control col-sm-4">
                            <option value="rgb" selected>RGBï¼ˆç®€åŒ–é€Ÿåº¦å¿«ï¼‰</option>
                            <option value="lab">Labï¼ˆæ„ŸçŸ¥æ›´å‡†ç¡®ï¼‰</option>
                            <option value="hsv">HSVï¼ˆè‰²ç›¸ä¼˜å…ˆï¼‰</option>
                            <option value="ciede2000">CIEDE2000ï¼ˆé«˜ç²¾åº¦ï¼‰</option>
                        </select>
                    </div>
                </div>
                    <div class="form-group">
                        <div class="row">
                            <label class="col-sm-2 col-form-label">å›¾ç‰‡ç­‰æ¯”ç¼©æ”¾/å¡«å……å¤§å°ï¼š</label>
                            <select id="scaleSizeSelect" class="form-control col-sm-2">
                                <option value="0" selected>ä¸ç¼©æ”¾ï¼ˆåŸå§‹å°ºå¯¸ï¼‰</option>
                                <option value="25">25x25</option>
                                <option value="50">50x50</option>
                                <option value="75">75x75</option>
                                <option value="100">100x100</option>
                            </select>
                            <div class="form-check col-sm-4 pl-4">
                                <input class="form-check-input" type="checkbox" value="1" id="noSliceIfSmaller">
                                <label class="form-check-label" for="noSliceIfSmaller">
                                    å¦‚æœç¼©æ”¾åå°äºå›¾å—å¤§å°åˆ™ä¸åˆ†å—
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <div id='mainContent'>
        <div class="row">
            <div class="col">
                <div class="card">
                    <div class="card-header">
                        åŸå§‹å›¾ç‰‡
                    </div>
                    <div class="card-body">
                        <canvas id="originalCanvas"></canvas>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card">
                    <div class="card-header">
                        å®Œæ•´å›¾ç‰‡
                    </div>
                    <div class="card-body">
                        <canvas id="fullCanvas"></canvas>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card">
                    <div class="card-header">
                        å›¾ç‰‡åˆ‡å—
                    </div>
                    <div class="card-body">
                        <table id='sliceImageContainer' class='table-bordered'>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="card">
            <div class="card-header">
                <label id='largePicInfo' class="col-form-label"></label>
                <div class="dropdown float-right mx-2">
                    <button class="btn btn-outline-danger dropdown-toggle" type="button" id="dropdownColorReplace"
                        data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        é¢œè‰²æ›¿æ¢
                    </button>
                    <div class="dropdown-menu dropdown-menu-right overflow-auto" aria-labelledby="dropdownColorReplace"
                        style="max-height:800px;">
                        <div class="px-4 py-3">
                            <button type="button" class="btn btn-danger btn-sm" id="removeAllColorReplace">å…¨éƒ¨åˆ é™¤</button>
                            <button type="button" class="btn btn-primary btn-sm"
                                id="showColorReplaceJsonModel">å¯¼å…¥/å¯¼å‡º</button>
                            <div class="dropdown-divider"></div>
                            <h6 class="dropdown-header">å…¨ä½“é¢œè‰²æ›¿æ¢åˆ—è¡¨</h6>
                            <table class="table table-sm" style="max-width: 180px;">
                                <thead>
                                    <th style="width: 36px;">æ—§</th>
                                    <th style="width: 36px;">æ–°</th>
                                    <th></th>
                                </thead>
                                <tbody id="colorReplaceTable">
                                </tbody>
                            </table>
                            <h6 class="dropdown-header">å•ä¸ªåƒç´ é¢œè‰²æ›¿æ¢åˆ—è¡¨</h6>
                            <table class="table table-sm" style="min-width: 220px;">
                                <thead>
                                    <th>åæ ‡</th>
                                    <th style="width: 36px;">æ—§</th>
                                    <th style="width: 36px;">æ–°</th>
                                    <th></th>
                                </thead>
                                <tbody id="pixelColorReplaceTable">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="dropdown float-right mx-2">
                    <button class="btn btn-outline-primary dropdown-toggle" type="button" id="dropdownColorSum"
                        data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        é¢œè‰²ç»Ÿè®¡
                    </button>
                    <div class="dropdown-menu dropdown-menu-right overflow-auto" aria-labelledby="dropdownColorSum"
                        id="colorSum" style="max-height:600px;min-width: 180px;">
                        <table class="table table-sm">
                            <thead>
                                <th style="width: 36px;">é¢œè‰²</th>
                                <th>æ•°é‡</th>
                                <th></th>
                            </thead>
                            <tbody id="colorSumTable">
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="float-right mx-2" id="brushToolBar">
                    <label id='brushInfo'></label>
                    <button type="button" class="btn btn-danger" id="disableBrushMode">é€€å‡º</button>
                </div>
            </div>
            <div class="card-body" style='padding: 0;'>
                <canvas id="viewCanvas"></canvas>
            </div>
        </div>
    </div>
    <div class="modal fade" id="colorModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h6 class="modal-title" id="pointDialogTitle"></h6>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div>
                        <div id="colorInfo"> </div>
                        <hr />
                        <button type="button" class="btn btn-primary" id='showSingleColor'>åªæ˜¾ç¤ºæ­¤é¢œè‰²</button>
                        <hr />
                        <strong>é¢œè‰²æ›¿æ¢ï¼š</strong>
                        <div id="colorSelector">
                        </div>
                        <div id='colorToolBar' class='row justify-content-around py-3'>
                            <button type="button" class="btn btn-primary" id='replaceColor'>æ›¿æ¢æ‰€æœ‰é¢œè‰²</button>
                            <button type="button" class="btn btn-primary" id='replacePixel'>åªæ›¿æ¢æ­¤åƒç´ ç‚¹</button>
                            <button type="button" class="btn btn-info" id='replacePixelBrush'>è¿›å…¥ç¬”åˆ·æ¨¡å¼</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="colorReplaceJsonModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">å¯¼å…¥/å¯¼å‡ºé¢œè‰²æ›¿æ¢é…ç½®</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <label>é¢œè‰²æ›¿æ¢é…ç½®:</label>
                    <textarea class="form-control" rows="10" id="colorReplaceJson"></textarea>
                    <div id="copySuccessAlert" class="alert alert-success">
                        <a href="#" class="close" data-dismiss="alert">&times;</a>
                        å¤åˆ¶æˆåŠŸï¼
                    </div>
                    <div id="importErrorAlert" class="alert alert-warning">
                        <a href="#" class="close" data-dismiss="alert">&times;</a>
                        å¯¼å…¥æ ¼å¼é”™è¯¯ï¼
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-primary" id="copyColorReplaceJson">å¤åˆ¶åˆ°å‰ªè´´æ¿</button>
                    <button type="button" class="btn btn-primary" id="importColorReplaceJson">å¯¼å…¥</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="docModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">ä½¿ç”¨è¯´æ˜</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>æœ¬ç¨‹åºä¸ºè¾…åŠ©æ‹¼è±†ï¼ˆFuse Beadï¼‰çš„åˆ¶ä½œè€Œå¼€å‘çš„è¾…åŠ©å·¥å…·ã€‚ä»¥ç½‘é¡µå½¢å¼è¿è¡Œï¼ŒåŸºäºHTML5+JSã€‚</p>
                    <p class="text-success">éšç§å£°æ˜ï¼šæ‰€æœ‰å›¾å½¢å¤„ç†å·¥ä½œéƒ½åœ¨æµè§ˆå™¨æœ¬åœ°è¿›è¡Œï¼Œä¸ä¼šä¸Šä¼ æˆ–ä¿å­˜æ‚¨çš„å›¾ç‰‡ã€‚</p>
                    <p>æ“ä½œæŒ‡å—ï¼š </p>
                    <p>
                        <ul>
                            <li>å¯ä»¥ä¸Šä¼ æœ¬åœ°å›¾ç‰‡ï¼Œå°†æ¯ä¸ªåƒç´ è½¬æ¢æˆä¸ºç›¸è¿‘é¢œè‰²çš„æ‹¼è±†å¹¶æ”¾å¤§ï¼Œä¾›å®é™…æ‹¼è±†æ—¶å‚è€ƒï¼›</li>
                            <li>å›¾ç‰‡é™åˆ¶å°ºå¯¸ä¸º3000x3000ï¼Œå»ºè®®ä½¿ç”¨PNGæ ¼å¼ï¼›</li>
                            <li>å¯ä»¥å°†å›¾ç‰‡åˆ‡åˆ†æˆä¸åŒå°ºå¯¸çš„å›¾å—ï¼Œç‚¹å‡»ä¸Šæ–¹å›¾å—æˆ–å…¨å›¾å¯ä»¥åˆ‡æ¢æ”¾å¤§éƒ¨åˆ†ï¼›</li>
                            <li>å¤§å›¾ä¸Šæ–¹çš„â€œé¢œè‰²ç»Ÿè®¡â€æŒ‰é’®å¯ä»¥æŸ¥çœ‹æ‰€æœ‰é¢œè‰²çš„æ‹¼è±†æ•°é‡ï¼›</li>
                            <li>å¯ä»¥åªæ˜¾ç¤ºæŸç§é¢œè‰²ç”¨äºå¿«é€Ÿæ‘†æ”¾æ‹¼è±†ï¼Œä¸€ç§æ–¹å¼æ˜¯ç‚¹å‡»å¤§å›¾ä¸Šçš„åƒç´ åœ¨å¼¹å‡ºå¯¹è¯æ¡†ä¸­æ“ä½œï¼Œå¦ä¸€ç§æ˜¯åœ¨é¢œè‰²ç»Ÿè®¡æŒ‰é’®ä¸­ç›´æ¥ç‚¹å‡»é¢œè‰²æ—è¾¹çš„&lt;&lt;æŒ‰é’®ï¼›</li>
                            <li>ç‚¹å‡»å¤§å›¾ä¸Šçš„åƒç´ ï¼Œå¯ä»¥åœ¨å¼¹å‡ºå¯¹è¯æ¡†ä¸­é€‰æ‹©æ›¿æ¢é¢œè‰²ï¼Œæœ‰ä¸‰ç§æ–¹æ³•ï¼š
                                <ul>
                                    <li>æ›¿æ¢æ‰€æœ‰é¢œè‰²ä¸ºå¦ä¸€ç§é¢œè‰²ï¼› </li>
                                    <li>æ›¿æ¢å½“å‰åƒç´ ä¸ºå¦ä¸€ç§é¢œè‰²ï¼› </li>
                                    <li>ä½¿ç”¨ç¬”åˆ·æ¨¡å¼åœ¨å¤§å›¾ä¸Šæ‰¹é‡ä¿®æ”¹é¢œè‰²ï¼›</li>
                                </ul>
                            </li>
                            <li>å¤§å›¾ä¸Šæ–¹çš„â€œé¢œè‰²æ›¿æ¢â€æŒ‰é’®å¯ä»¥æŸ¥çœ‹å¹¶åˆ é™¤æ‰€æœ‰å·²æ›¿æ¢çš„é¢œè‰²ï¼Œä¹Ÿå¯ä»¥å¯¼å…¥/å¯¼å‡ºæ‰€æœ‰æ›¿æ¢åˆ—è¡¨ï¼Œæ–¹ä¾¿åˆ¶ä½œå¤§å‹æ‹¼è±†é¡¹ç›®ã€‚</li>
                        </ul>
                    </p>
                    <p>å½“å‰çš„æ‹¼è±†è°ƒè‰²æ¿é»˜è®¤ä¸º<b>Mard</b>å“ç‰Œçš„èåˆè±†ï¼Œå¹¶å¢åŠ äº†å›½å†…å¸¸è§å‚å®¶çš„é¢œè‰²ä½œä¸ºå‚è€ƒã€‚</p>
                    <p>è°ƒè‰²æ¿å¼•ç”¨è‡ªï¼š<a
                            href="https://www.reddit.com/r/beadsprites/comments/7ebgal/xml_files_of_all_the_colors_hama_perler_nabbi/"
                            target="_blank" class="text-secondary">RedditåŸå¸–</a></p>
                    <p class="text-info">æœ€åä¿®æ”¹æ—¶é—´ï¼š2025.10.21</p class="text-info">
                    <p class="text-right">
                        modified by 1cngğŸ§‘ğŸ»â€ğŸ’»
                    </p>
                </div>
            </div>
        </div>
    </div>
    <div class="modal hide" id="loadingMask" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="static"
        data-keyboard="false">
        <divÂ class="modal-dialog"Â role="document">
            Â <divÂ class="modal-content">
                <divÂ class="modal-body">
                    <div class="mask">
                        <div class="spinner-border text-dark m-3" role="status">
                            <span class="sr-only"></span>
                        </div>
                        <span class="h1"> ç»˜åˆ¶ä¸­...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

<script type="text/javascript">
    const pixelSize = 20,//é©¬èµ›å…‹åƒç´ å°ºå¯¸ï¼ˆæ”¾å¤§å€æ•°ï¼‰
        dragMinTimeSpan = 20,//æ‹–æ‹½æ‰€éœ€çš„é¼ æ ‡æŒ‰ä¸‹æœ€å°æ—¶é—´é—´éš”ï¼ˆmsï¼‰
        dragMinDistance = 8,//æ‹–æ‹½æ‰€éœ€çš„é¼ æ ‡ç§»åŠ¨æœ€å°è·ç¦»ï¼ˆåƒç´ ï¼‰
        imageSizeLimit = 3000;//å›¾ç‰‡å°ºå¯¸å¤§å°é™åˆ¶ï¼ˆæé«˜åˆ°3000ï¼‰

    const imageWarnThreshold = 2000; // è¶…è¿‡æ­¤å°ºå¯¸æç¤ºæ€§èƒ½è­¦å‘Š
    const autoScaleDefault = 2000; // è‡ªåŠ¨ç¼©æ”¾ç›®æ ‡ï¼ˆçŸ­è¾¹ï¼‰

    var pieceSize = 40;//å•å—æ‹¼æ¿å®¹çº³çš„æ‹¼è±†æ•°
        colorMatchModel = 'rgb'; // é¢œè‰²åŒ¹é…

    var scaleTarget = 0; // 0 means no scaling, otherwise target short side in pixels
    var noSliceIfSmaller = false; // if true and scaled image is smaller than pieceSize, skip slicing
    var lastUploadedImage = null; // Image object waiting for user to click "process"

    var paletteMap = generatePaletteMap(allPalettes.get("mard")),//è°ƒè‰²æ¿å¯¹è±¡
        similarColorCache = new Map(),//ä¸å®é™…é¢œè‰²æœ€ç›¸è¿‘çš„è°ƒè‰²æ¿é¢œè‰²ç¼“å­˜
        paletteImageData = new Array(),//å­˜å‚¨åŸå§‹å›¾ç‰‡æ›¿æ¢è°ƒè‰²æ¿é¢œè‰²åçš„åŸå›¾
        sliceImages = new Array(),//å­˜å‚¨æ‰€æœ‰åˆ‡å—å›¾çš„äºŒç»´æ•°ç»„
        currentSliceImage = null;//å½“å‰æ˜¾ç¤ºçš„åˆ‡å—å›¾ä½ç½®ï¼ˆæ˜¾ç¤ºå…¨å›¾æ—¶ä¸ºnullï¼‰

    var selectedPixel = null,//å½“å‰é€‰ä¸­çš„åƒç´ ç‚¹ï¼ˆx,y,color)
        filterColor = '',//é¢œè‰²ç­›é€‰ï¼ˆåªæ˜¾ç¤ºæ­¤é¢œè‰²çš„è‰²å—ï¼‰
        colorReplaceList = new Map(),//é¢œè‰²æ›¿æ¢åˆ—è¡¨
        pixelColorReplaceList = new Map();//é¢œè‰²æ›¿æ¢åˆ—è¡¨ï¼ˆå•ä¸ªåƒç´ ï¼‰

    var isMouseDown = false,
        mousedownStartTime = null,//é¼ æ ‡æŒ‰ä¸‹çš„æ—¶é—´
        mousedownStartX = 0,//é¼ æ ‡æŒ‰ä¸‹çš„èµ·ç‚¹X
        mousedownStartY = 0,//é¼ æ ‡æŒ‰ä¸‹çš„èµ·ç‚¹Y
        isDragging = false,//è§†å›¾æ˜¯å¦æ­£åœ¨æ‹–æ‹½ä¸­
        isBrushMode = false,//æ˜¯å¦å¤„äºç¬”åˆ·æ¨¡å¼ï¼ˆç‚¹å‡»å¤§å›¾ç›´æ¥æ¢è‰²ï¼‰
        brushColor = '';//ç¬”åˆ·é¢œè‰²

    var largeCanvas,//ç”Ÿæˆçš„é©¬èµ›å…‹å¤§å›¾Canvasï¼Œåˆ‡å‡ºä¸€éƒ¨åˆ†æ˜¾ç¤ºåœ¨ViewCanvas
        largeCanvasStartOffsetX = 0,//æ‹–æ‹½å¼€å§‹æ—¶çš„èƒŒæ™¯Xåæ ‡åç§»
        largeCanvasStartOffsetY = 0,//æ‹–æ‹½å¼€å§‹æ—¶çš„èƒŒæ™¯Yåæ ‡åç§»
        largeCanvasOffsetX = 0,//èƒŒæ™¯å¤§å›¾çš„Xåæ ‡åç§»
        largeCanvasOffsetY = 0,//èƒŒæ™¯å¤§å›¾çš„Yåæ ‡åç§»
        isDrawingViewCanvas = false,//è§†å›¾æ˜¯å¦æ­£åœ¨ç»˜åˆ¶ä¸­
        colorSum = new Map();//å¤§å›¾é¢œè‰²ç»Ÿè®¡

    var scrollbarWidth = getScrollbarWidth();

    var rulerX1Canvas, rulerX2Canvas, rulerY1Canvas, rulerY2Canvas;//å››ä¸ªæ ‡å°ºçš„canvas

    $().ready(function () {
        var originalCanvas = document.getElementById('originalCanvas'),//åŸå§‹å›¾ç‰‡canvas
            fullCanvas = document.getElementById('fullCanvas'),//å®Œæ•´å›¾ç‰‡canvas
            viewCanvas = document.getElementById('viewCanvas');//è§†å›¾ï¼ˆå¯æ‹–æ‹½ç‚¹å‡»ï¼‰canvas

        //æ˜¾ç¤ºè°ƒè‰²æ¿é€‰è‰²å™¨
        generateColorSelectorHtml();

        $('#brushToolBar').hide();

        //äº‹ä»¶ç»‘å®š
        {
            var lastWindowWidth = window.innerWidth;
            //çª—å£é‡ç»˜åé‡è®¾canvaså°ºå¯¸
            window.addEventListener('resize', function (e) {
                //åªæœ‰å®½åº¦çœŸæ­£æ”¹å˜æ—¶æ‰ç»§ç»­ï¼Œé˜»æ­¢ç§»åŠ¨è®¾å¤‡ä¸Šçš„æ‹–æ‹½è¯¯è§¦å‘resizeäº‹ä»¶
                if (lastWindowWidth == window.innerWidth) return;
                lastWindowWidth = window.innerWidth;

                if (!$('#mainContent').is(":hidden")) {
                    resizeViewCanvasFitWindow();
                    refreshImage();
                }
            }, false);

            // å›¾ç‰‡é€‰æ‹©äº‹ä»¶ï¼šä»…è¯»å–å¹¶ä¿å­˜ä¸º lastUploadedImageï¼Œç­‰å¾…ç”¨æˆ·ç‚¹å‡» "å¤„ç†å›¾ç‰‡"
            $('#imageChooser').change(function (e) {
                $(this).next('.custom-file-label').html(e.target.files[0] ? e.target.files[0].name : '');
                if (!e.target.files || e.target.files.length <= 0) return;
                let imageFile = e.target.files[0];
                var reader = new FileReader();
                reader.onload = function (ev) {
                    var image = new Image();
                    image.src = ev.target.result;
                    image.onload = function () {
                        // basic size check (we allow up to imageSizeLimit but warn if over warn threshold)
                        if (this.width > imageSizeLimit || this.height > imageSizeLimit) {
                            alert('å›¾ç‰‡åˆ†è¾¨ç‡' + this.width + 'x' + this.height + 'è¿‡å¤§ï¼Œéœ€å°äº' + imageSizeLimit + 'x' + imageSizeLimit);
                            return;
                        }

                        lastUploadedImage = this; // store for later processing
                        $('#processImageBtn').prop('disabled', false);
                        $('#mainContent').hide();

                        // show a warning if image is large
                        if (this.width >= imageWarnThreshold || this.height >= imageWarnThreshold) {
                            $('#imageWarning').text('æç¤ºï¼šå›¾ç‰‡å°ºå¯¸è¾ƒå¤§ï¼Œå¤„ç†å¯èƒ½è¾ƒæ…¢ã€‚');
                        } else {
                            $('#imageWarning').text('');
                        }
                    };
                };
                reader.readAsDataURL(imageFile);
            });

            // å¤„ç†å›¾ç‰‡æŒ‰é’®
            $('#processImageBtn').on('click', function () {
                if (!lastUploadedImage) return;
                processPendingImage({ autoScale: false });
            });

            //æ‹¼è±†å“ç‰Œå˜åŒ–ï¼ˆä»…æ›´æ–°è°ƒè‰²æ¿ï¼Œä¸è‡ªåŠ¨é‡å¤„ç†ï¼Œæç¤ºç”¨æˆ·æ‰‹åŠ¨ç‚¹å‡»å¤„ç†ï¼‰
            $('#paletteSelect').change(function (e) {
                if (this.value && allPalettes.has(this.value)) {
                    paletteMap = generatePaletteMap(allPalettes.get(this.value));//é‡æ–°åŠ è½½è°ƒè‰²æ¿
                    //åˆ·æ–°è°ƒè‰²æ¿é€‰è‰²å™¨   
                    generateColorSelectorHtml();
                    if (!$('#mainContent').is(':hidden')) {
                        $('#imageWarning').text('å·²æ›´æ”¹æ‹¼è±†å“ç‰Œï¼Œç‚¹å‡»â€œå¤„ç†å›¾ç‰‡â€ä»¥åº”ç”¨æ›´æ”¹ã€‚');
                    }
                }
            });

            //æ‹¼æ¿å°ºå¯¸å˜åŒ–ï¼ˆä»…æ›´æ–°é…ç½®ï¼Œéœ€æ‰‹åŠ¨å¤„ç†å›¾ç‰‡ä»¥åº”ç”¨ï¼‰
            $('#pieceSizeSelect').change(function (e) {
                if (this.value && parseInt(this.value)) {
                    pieceSize = parseInt(this.value);
                    if (!$('#mainContent').is(':hidden')) {
                        resizeViewCanvasFitWindow();
                        $('#imageWarning').text('å·²æ›´æ”¹å›¾å—å¤§å°ï¼Œç‚¹å‡»â€œå¤„ç†å›¾ç‰‡â€ä»¥åº”ç”¨æ›´æ”¹ã€‚');
                    }
                }
            });

            //é¢œè‰²åŒ¹é…æœºåˆ¶å˜åŒ–ï¼ˆåªæ”¹å˜åŒ¹é…ç®—æ³•ï¼Œéœ€æ‰‹åŠ¨å¤„ç†å›¾ç‰‡ä»¥ç”Ÿæ•ˆï¼‰
            $('#colorDistanceSelect').change(function (e) {
                if (this.value) {
                    colorMatchModel = this.value;
                    if (!$('#mainContent').is(':hidden')) {
                        $('#imageWarning').text('å·²æ›´æ”¹é¢œè‰²åŒ¹é…æ–¹å¼ï¼Œç‚¹å‡»â€œå¤„ç†å›¾ç‰‡â€ä»¥åº”ç”¨æ›´æ”¹ã€‚');
                    }
                }
            });

            //ç‚¹å‡»æ˜¾ç¤ºå…¨å›¾
            $(fullCanvas).on('click tap', function (e) {
                showLoadingMask(() => {
                    showFullImageView();
                });
            });

            //åªæ˜¾ç¤ºæŸé¢œè‰²æŒ‰é’®ç‚¹å‡»
            $('#showSingleColor').on('click tap', function (e) {
                $('#colorModal').modal('hide');
                filterColor = selectedPixel.color;
                refreshImage();
            });

            //æ›¿æ¢å•ä¸ªåƒç´ æŒ‰é’®ç‚¹å‡»
            $('#replacePixel').on('click tap', function (e) {
                $('#colorModal').modal('hide');
                if (!this.value) return;
                //æ›¿æ¢åƒç´ åæ ‡ä½¿ç”¨çš„æ˜¯å…¨å›¾çœŸå®åæ ‡
                let position = getRealPosition(selectedPixel.x, selectedPixel.y);
                replacePixelColor(position.x, position.y, this.value);
                refreshColorReplaceList();
                refreshImage();
            });

            //æ›¿æ¢ç›¸åŒé¢œè‰²æŒ‰é’®ç‚¹å‡»
            $('#replaceColor').on('click tap', function (e) {
                $('#colorModal').modal('hide');
                if (!this.value) return;
                replaceColor(selectedPixel.color, this.value);
                refreshColorReplaceList();
                refreshImage();
            });

            //è¿›å…¥ç¬”åˆ·æ¨¡å¼æŒ‰é’®ç‚¹å‡»
            $('#replacePixelBrush').on('click tap', function (e) {
                if (isBrushMode) return;

                $('#colorModal').modal('hide');
                isBrushMode = true;
                brushColor = this.value;
                $('#brushInfo').html("ç¬”åˆ·æ¨¡å¼:<div class='colorBlock' style='color:" + getFontColor(brushColor) + "; background:#" + brushColor + ";'>" + paletteMap.get(brushColor).name + "</div>");
                $('#brushToolBar').show();
            });

            //é€€å‡ºç¬”åˆ·æ¨¡å¼æŒ‰é’®ç‚¹å‡»
            $('#disableBrushMode').on('click tap', function (e) {
                isBrushMode = false;
                brushColor = '';
                $('#brushInfo').html('');
                $('#brushToolBar').hide();
            });

            //å…³é—­é¢œè‰²å¯¹è¯æ¡†
            $('#colorModal').on('hidden.bs.modal', function (e) {
                //æ¸…é™¤å½“å‰å¯¹è¯æ¡†ä¸­çš„æ‰€é€‰å€¼
                selectedColor = null;
                $("#colorSelector>div.selected").removeClass("selected");
                $('#replacePixel').val('');
                $('#replaceColor').val('');
            });

            //ç§»é™¤æ‰€æœ‰é¢œè‰²æ›¿æ¢é€‰é¡¹
            $('#removeAllColorReplace').on('click tap', function (e) {
                colorReplaceList = new Map();
                pixelColorReplaceList = new Map();
                refreshColorReplaceList();
                refreshImage();
            });

            //é¢œè‰²æ›¿æ¢é€‰é¡¹å¯¼å…¥/å¯¼å‡ºæŒ‰é’®
            $('#showColorReplaceJsonModel').on('click tap', function (e) {
                if (pixelColorReplaceList.size == 0 && colorReplaceList.size == 0) {
                    $('#colorReplaceJson').val('');
                }
                else {
                    //ç”Ÿæˆjson
                    let jsonObj = {
                        pixelColorReplaceList: [...pixelColorReplaceList],
                        colorReplaceList: [...colorReplaceList]
                    };
                    $('#colorReplaceJson').val(JSON.stringify(jsonObj));
                }

                $("#copySuccessAlert").hide();
                $("#importErrorAlert").hide();
                $('#colorReplaceJsonModal').modal('show');
            });

            //å¤åˆ¶é¢œè‰²æ›¿æ¢é€‰é¡¹jsonåˆ°å‰ªè´´æ¿
            $('#copyColorReplaceJson').on('click tap', function (e) {
                if ($('#colorReplaceJson').val().trim().length == 0) return;

                $('#colorReplaceJson').select();
                document.execCommand("Copy");//æ‰§è¡Œæµè§ˆå™¨å¤åˆ¶å‘½ä»¤
                $("#copySuccessAlert").show().delay(2000).slideUp(200, function () {
                    $(this).hide();
                });
            });

            //å¯¼å…¥é¢œè‰²æ›¿æ¢é€‰é¡¹
            $('#importColorReplaceJson').on('click tap', function (e) {
                let json = $('#colorReplaceJson').val();
                if (!json) return;
                try {
                    let jsonObj = JSON.parse(json);
                    if (!jsonObj || !jsonObj.pixelColorReplaceList || !jsonObj.pixelColorReplaceList) {
                        console.log('jsonæ ¼å¼é”™è¯¯');
                        $("#importErrorAlert").show().delay(2000).slideUp(200, function () {
                            $(this).hide();
                        });
                        return;
                    }
                    pixelColorReplaceList = new Map(jsonObj.pixelColorReplaceList);
                    colorReplaceList = new Map(jsonObj.colorReplaceList);

                    refreshColorReplaceList();
                    refreshImage();
                    $('#colorReplaceJsonModal').modal('hide');
                } catch (e) {
                    console.log(e);
                    $("#importErrorAlert").alert().delay(2000).slideUp(200, function () {
                        $(this).alert('close');
                    });
                }
            });

        }

        //è§†å›¾äº’åŠ¨äº‹ä»¶
        {
            viewCanvas.onmousedown = function (e) {
                if (e.buttons == 1 && largeCanvas) {//ç‚¹å‡»å·¦é”®å¹¶ä¸”åœ¨å¤§å›¾å·²åŠ è½½æƒ…å†µä¸‹å¼€å§‹æ‹–æ‹½
                    mousedownStartX = e.clientX;
                    mousedownStartY = e.clientY;
                    isMouseDown = true;
                    mousedownStartTime = new Date().getTime();
                    // isDragging = true;
                }
            };
            viewCanvas.onmousemove = function (e) {
                //é¼ æ ‡æŒ‰ä¸‹ä¸”ç§»åŠ¨è¶³å¤Ÿæ—¶é—´å’Œè·ç¦»åï¼Œåˆ¤å®šä¸ºå¼€å§‹æ‹–æ‹½
                if (isMouseDown & !isDragging) {
                    let mousedownTime = new Date().getTime() - mousedownStartTime;
                    if (mousedownTime > dragMinTimeSpan) {
                        let mousemoveDistance = Math.abs(mousedownStartX - e.clientX) + Math.abs(mousedownStartY - e.clientY);
                        if (mousemoveDistance > dragMinDistance) {
                            isDragging = true;
                        }
                    }
                }
                else if (isDragging && !isDrawingViewCanvas) {
                    //è®¡ç®—å¤§å›¾åç§»å€¼
                    largeCanvasOffsetX = largeCanvasStartOffsetX + mousedownStartX - e.clientX;
                    largeCanvasOffsetY = largeCanvasStartOffsetY + mousedownStartY - e.clientY;
                    if (largeCanvasOffsetX > largeCanvas.width - viewCanvas.width + 2 * (pixelSize + 1)) largeCanvasOffsetX = largeCanvas.width - viewCanvas.width + 2 * (pixelSize + 1);
                    if (largeCanvasOffsetX < 0) largeCanvasOffsetX = 0;
                    if (largeCanvasOffsetY > largeCanvas.height - viewCanvas.height + 2 * (pixelSize + 1)) largeCanvasOffsetY = largeCanvas.height - viewCanvas.height + 2 * (pixelSize + 1);
                    if (largeCanvasOffsetY < 0) largeCanvasOffsetY = 0;
                    requestAnimationFrame(function () {
                        showPartView();
                    });
                }
            };
            viewCanvas.onmouseup = function (e) {
                //é¼ æ ‡æŒ‰ä¸‹ä½†æœªæ‹–æ‹½æ—¶æ¾å¼€é¼ æ ‡ï¼Œè§¦å‘ç‚¹å‡»
                if (isMouseDown && !isDragging) {
                    viewCanvasClick(e);
                }
                isDragging = false;
                isMouseDown = false;
                largeCanvasStartOffsetX = largeCanvasOffsetX;
                largeCanvasStartOffsetY = largeCanvasOffsetY;
            };
            viewCanvas.onmouseout = function (e) {
                isDragging = false;
                isMouseDown = false;
                largeCanvasStartOffsetX = largeCanvasOffsetX;
                largeCanvasStartOffsetY = largeCanvasOffsetY;
            };

            //è§¦æ‘¸äº‹ä»¶è§¦å‘é¼ æ ‡äº‹ä»¶ï¼ˆç§»åŠ¨ç«¯ï¼‰
            viewCanvas.ontouchstart = function (e) {
                e.preventDefault();
                let touch = e.touches[0];
                viewCanvas.dispatchEvent(new MouseEvent("mousedown", {
                    buttons: 1,
                    clientX: touch.clientX,
                    clientY: touch.clientY
                }));
            };
            viewCanvas.ontouchmove = function (e) {
                e.preventDefault();
                let touch = e.touches[0];
                viewCanvas.dispatchEvent(new MouseEvent("mousemove", {
                    buttons: 1,
                    clientX: touch.clientX,
                    clientY: touch.clientY
                }));
            };
            viewCanvas.ontouchend = function (e) {
                e.preventDefault();
                let touch = e.changedTouches[0];
                viewCanvas.dispatchEvent(new MouseEvent("mouseup", {
                    buttons: 1,
                    clientX: touch.clientX,
                    clientY: touch.clientY
                }));
            };
            viewCanvas.ontouchcancel = function (e) {
                e.preventDefault();
                viewCanvas.dispatchEvent(new MouseEvent("mouseout", {}));
            };
        }

    });

    // å¤„ç†ç­‰å¾…ä¸­çš„å›¾ç‰‡ï¼ˆç”±ç”¨æˆ·ç‚¹å‡»æŒ‰é’®è§¦å‘ï¼‰
    function processPendingImage(options) {
        if (!lastUploadedImage) return;
        options = options || {};
        let img = lastUploadedImage;

        showLoadingMask(() => {
            // æ¸…ç©ºç¼“å­˜ä¸çŠ¶æ€
            similarColorCache = new Map();
            paletteImageData = new Array();
            sliceImages = new Array();
            currentSliceImage = null;
            largeCanvasOffsetX = 0;
            largeCanvasOffsetY = 0;
            colorReplaceList = new Map();
            pixelColorReplaceList = new Map();
            refreshColorReplaceList();

            $('#mainContent').show();

            // determine scaleTarget: priority -> explicit select, then autoscale option
            let selectTarget = parseInt($('#scaleSizeSelect').val() || '0');
            scaleTarget = isNaN(selectTarget) ? 0 : selectTarget;
            noSliceIfSmaller = !!$('#noSliceIfSmaller').prop('checked');

            if (options.autoScale) {
                scaleTarget = options.autoScaleTarget || autoScaleDefault;
            }

            let originalCtx = document.getElementById('originalCanvas').getContext('2d');
            let originalCanvas = document.getElementById('originalCanvas');
            originalCtx.clearRect(0, 0, originalCanvas.width, originalCanvas.height);

            if (scaleTarget > 0) {
                let w = img.width, h = img.height;
                let scale = scaleTarget / Math.min(w, h);
                let newW = Math.max(1, Math.round(w * scale));
                let newH = Math.max(1, Math.round(h * scale));
                originalCanvas.width = newW;
                originalCanvas.height = newH;
                originalCtx.drawImage(img, 0, 0, newW, newH);
            } else {
                originalCanvas.width = img.width;
                originalCanvas.height = img.height;
                originalCtx.drawImage(img, 0, 0);
            }

            // trim, map to palette, slice and show
            trimCanvas(originalCanvas);
            toPaletteColor(originalCanvas, document.getElementById('fullCanvas'));
            sliceCanvasToImage(document.getElementById('fullCanvas'), 'sliceImageContainer');
            showFullImageView();

            // keep lastUploadedImage so user can tweak options and reprocess without reselecting
            $('#imageWarning').text('');
        });
    }

    //è§†å›¾ç‚¹å‡»ï¼ˆè§¦æ‘¸ï¼‰æ“ä½œ
    function viewCanvasClick(e) {
        //å®é™…åœ¨å…¨å›¾ä¸Šçš„ç‚¹å‡»åæ ‡
        let rect = viewCanvas.getBoundingClientRect();
        let realClickX = e.clientX - rect.left + largeCanvasOffsetX - (pixelSize + 1),
            realClickY = e.clientY - rect.top + largeCanvasOffsetY - (pixelSize + 1);
        //å¦‚æœç‚¹åœ¨æ ‡å°ºä¸Šåˆ™ä¸è§¦å‘äº‹ä»¶
        if (realClickX < 0 || realClickX > viewCanvas.width + largeCanvasOffsetX - 2 * (pixelSize + 1)
            || realClickY < 0 || realClickY > viewCanvas.height + largeCanvasOffsetY - 2 * (pixelSize + 1)) return;

        //å¦‚æœå½“å‰æ­£åœ¨è¿‡æ»¤é¢œè‰²ï¼Œåˆ™æ¢å¤å…¨éƒ¨é¢œè‰²
        if (filterColor) {
            filterColor = null;
            refreshImage();
            return;
        }

        //å®é™…åƒç´ åæ ‡
        let pointX = ~~(realClickX / (pixelSize + 1)),
            pointY = ~~(realClickY / (pixelSize + 1));

        //å…¨å›¾çœŸå®åæ ‡
        let realPosition = getRealPosition(pointX, pointY);

        let pointColorHex = getFullCanvasColor(realPosition.x, realPosition.y);//æ˜¾ç¤ºçš„é¢œè‰²
        if (!pointColorHex) return;//ä¸æ“ä½œé€æ˜åƒç´ å’Œè¶…å‡ºèŒƒå›´çš„åƒç´ 


        //å¦‚æœå¤„äºç¬”åˆ·æ¨¡å¼åˆ™ä¿®æ”¹åƒç´ é¢œè‰²
        if (isBrushMode) {
            replacePixelColor(realPosition.x, realPosition.y, brushColor);
            refreshColorReplaceList();
            refreshImage();
            return;
        }

        let sourceColorHex = getFullImageColor(realPosition.x, realPosition.y);//åŸå§‹é¢œè‰²
        let pointColor = paletteMap.get(pointColorHex);
        if (sourceColorHex == pointColorHex) {
            //æœªæ¢è‰²çš„æƒ…å†µ
            $('#colorInfo').html(" <strong>é¢œè‰²</strong><div class='colorBlock' style='color:" + getFontColor(pointColorHex)
                + "; background:#" + pointColorHex + ";'>" + pointColor.name + "</div>#" + pointColorHex);
        }
        else {
            //æ¢è‰²çš„æƒ…å†µ
            let sourceColor = paletteMap.get(sourceColorHex);
            $('#colorInfo').html(" <strong>å½“å‰é¢œè‰²</strong><div class='colorBlock' style='color:" + getFontColor(pointColorHex)
                + "; background:#" + pointColorHex + ";'>" + pointColor.name + "</div>#" + pointColorHex
                + " <strong>åŸå§‹é¢œè‰²</strong><div class='colorBlock' style='color:" + getFontColor(sourceColorHex)
                + "; background:#" + sourceColorHex + ";'>" + sourceColor.name + "</div>#" + sourceColorHex);
        }

        selectedPixel = { x: pointX, y: pointY, color: pointColorHex, name: pointColor.name };
        $('#showSingleColor').html('åªæ˜¾ç¤º' + colorSum.get(pointColorHex) + 'ä¸ª' + pointColor.name);
        $('#pointDialogTitle').html("<strong>å¤§å›¾åæ ‡</strong>(" + (pointX + 1) + "," + (pointY + 1) + ")");
        $('#colorToolBar').css('visibility', 'hidden');//å ä½éšè—å·¥å…·æ 
        $('#colorModal').modal('show');
    }

    //è·å–å…¨å›¾æŒ‡å®šåæ ‡ç‚¹å¯¹åº”çš„å›¾ç‰‡è‰²å€¼
    function getFullCanvasColor(x, y) {
        //æ ¹æ®å½“å‰æ˜¾ç¤ºçš„æ˜¯å…¨å›¾è¿˜æ˜¯åˆ‡å—ï¼Œè¯»å–åæ ‡æ‰€åœ¨rgbæ•°æ®
        let imageData, cursor;
        let fullCtx = fullCanvas.getContext('2d');
        imageData = fullCtx.getImageData(0, 0, fullCanvas.width, fullCanvas.height);
        cursor = (y * fullCanvas.width + x) * 4;

        if (cursor + 3 >= imageData.data.length) return null;//è¶…å‡ºå›¾åƒèŒƒå›´è¿”å›null

        if (imageData.data[cursor + 3] == 0) return null;//é€æ˜è‰²è¿”å›null

        return rgbToHex(imageData.data[cursor], imageData.data[cursor + 1], imageData.data[cursor + 2]);
    }

    //è·å–æ¢è‰²åŸå§‹å›¾æŒ‡å®šåæ ‡ç‚¹å¯¹åº”çš„å›¾ç‰‡è‰²å€¼
    function getFullImageColor(x, y) {
        let cursor = (y * paletteImageData.width + x) * 4;
        if (paletteImageData.data[cursor + 3] == 0) return null;

        return rgbToHex(paletteImageData.data[cursor], paletteImageData.data[cursor + 1], paletteImageData.data[cursor + 2]);
    }

    //å»é™¤canvasè¾¹ç¼˜çš„é€æ˜å’Œç™½è‰²åƒç´ 
    function trimCanvas(canvas) {
        let ctx = canvas.getContext('2d'),
            imageData = ctx.getImageData(0, 0, canvas.width, canvas.height),
            bound = {
                top: canvas.height,
                left: canvas.width,
                right: 0,
                bottom: 0
            };

        for (let i = 0; i < imageData.data.length; i += 4) {
            if (imageData.data[i + 3] !== 0
                && (imageData.data[i] < 250 || imageData.data[i + 1] < 250 || imageData.data[i + 2] < 250)) {//é€æ˜æˆ–è€…è¿‘ä¼¼ç™½è‰²éƒ½ä½œä¸ºç™½è‰²å»æ‰
                let x = (i / 4) % canvas.width;
                let y = ~~((i / 4) / canvas.width);

                if (bound.top > y) bound.top = y;
                if (bound.left > x) bound.left = x;
                if (bound.right < x) bound.right = x;
                if (bound.bottom < y) bound.bottom = y;
            }
        }

        //å–å‡ºè£å‰ªå›¾ç‰‡çš„å®½é«˜
        let trimHeight = bound.bottom - bound.top + 1,
            trimWidth = bound.right - bound.left + 1,
            trimmedImage = ctx.getImageData(bound.left, bound.top, trimWidth, trimHeight);

        canvas.width = trimWidth;
        canvas.height = trimHeight;
        ctx.putImageData(trimmedImage, 0, 0);
    }

    //å°†canvasé¢œè‰²è¾“å‡ºä¸ºæœ€ç›¸è¿‘çš„è°ƒè‰²æ¿é¢œè‰²
    function toPaletteColor(sourceCanvas, destCanvas) {
        let sourceCtx = sourceCanvas.getContext('2d'),
            destCtx = destCanvas.getContext('2d'),
            imageData = sourceCtx.getImageData(0, 0, sourceCanvas.width, sourceCanvas.height);

        //é€åƒç´ è¯»å–åŸå›¾å¹¶å¯»æ‰¾é¢œè‰²å€¼
        for (let i = 0; i < imageData.data.length; i += 4) {
            //è¯»å–é¢œè‰²ï¼Œå¦‚æœé€æ˜åˆ™è·³è¿‡
            let a = imageData.data[i + 3];
            if (a == 0) continue;

            //åŠ é€æ˜åº¦é€‰é¡¹
            let r = ~~(imageData.data[i] * a / 255);
            let g = ~~(imageData.data[i + 1] * a / 255);
            let b = ~~(imageData.data[i + 2] * a / 255);

            let x = (i / 4) % sourceCanvas.width;
            let y = ~~((i / 4) / sourceCanvas.width);

            //ç»˜åˆ¶è°ƒè‰²æ¿å›¾
            let similarColor = findSimilarColor(r, g, b);
            imageData.data[i] = similarColor.r;
            imageData.data[i + 1] = similarColor.g;
            imageData.data[i + 2] = similarColor.b;
            imageData.data[i + 3] = 255;//å¤„ç†åä¸€å¾‹å˜æˆä¸é€æ˜è‰²
        }

        //ä¿å­˜æ¢è‰²åçš„åŸå›¾
        paletteImageData = imageData;

        similarColorCache = null;
        destCanvas.width = sourceCanvas.width;
        destCanvas.height = sourceCanvas.height;
        destCtx.putImageData(imageData, 0, 0);
    }

    //å°†canvasåˆ†å‰²ä¸ºå°å›¾å¹¶è¾“å‡ºä¸ºå¯ç‚¹å‡»çš„imageé›†åˆ
    function sliceCanvasToImage(canvas, sliceContainerName) {
        let ctx = canvas.getContext('2d'),
            rowCount = Math.ceil(canvas.height / pieceSize),//åˆ†å‰²è¡Œæ•°
            colCount = Math.ceil(canvas.width / pieceSize);//åˆ†å‰²åˆ—æ•°

        // å¦‚æœç”¨æˆ·é€‰æ‹©äº† "å¦‚æœç¼©æ”¾åå°äºå›¾å—å¤§å°åˆ™ä¸åˆ†å—"ï¼Œå¹¶ä¸”å›¾åƒæ•´ä½“å°ºå¯¸å°äºæˆ–ç­‰äºå•å—å°ºå¯¸ï¼Œåˆ™åªæ˜¾ç¤ºä¸€å¼ å›¾ï¼ˆä¸åˆ†å—ï¼‰
        if (noSliceIfSmaller && canvas.width <= pieceSize && canvas.height <= pieceSize) {
            // create a single-cell table with the full image centered in pieceSize canvas
            let tempCanvas = document.createElement('canvas');
            tempCanvas.width = pieceSize;
            tempCanvas.height = pieceSize;
            let tempCtx = tempCanvas.getContext('2d');
            tempCtx.clearRect(0, 0, pieceSize, pieceSize);
            // draw canvas content centered
            let dx = Math.floor((pieceSize - canvas.width) / 2);
            let dy = Math.floor((pieceSize - canvas.height) / 2);
            tempCtx.drawImage(canvas, 0, 0, canvas.width, canvas.height, dx, dy, canvas.width, canvas.height);

            let tableHtml = '<tr><td><img id="sliceImage-0_0" /></td></tr>';
            $('#' + sliceContainerName).html(tableHtml);
            let tempImageURL = tempCanvas.toDataURL('image/png');
            let img = $('#sliceImage-0_0');
            img.attr('src', tempImageURL);
            sliceImages = [[ctx.getImageData(0, 0, canvas.width, canvas.height)]];
            img.click(function () {
                showLoadingMask(() => {
                    currentSliceImage = { x: 0, y: 0 };
                    showImageView(sliceImages[0][0]);
                });
            });
            return;
        }

        //ç”Ÿæˆtableå’Œimageæ ‡ç­¾
        let tableHtml = '';
        for (let y = 0; y < rowCount; y++) {
            tableHtml += "<tr>";
            for (let x = 0; x < colCount; x++) {
                tableHtml += "<td><img id='sliceImage-" + y + "_" + x + "' /></td>";
            }
            tableHtml += "</tr>";
        }
        $('#' + sliceContainerName).html(tableHtml);

        //ç”Ÿæˆä¸´æ—¶Canvasç”¨äºè½¬æ¢åˆ†å‰²å°å›¾
        let tempCanvas = document.createElement('canvas'),
            tempCtx = tempCanvas.getContext('2d');
        tempCanvas.width = pieceSize;
        tempCanvas.height = pieceSize;
        tempCtx.font = ~~(pieceSize / 4) + 'px monospace';
        tempCtx.strokeStyle = '#000';
        tempCtx.textBaseline = 'bottom';
        tempCtx.textAlign = 'right';

        sliceImages = new Array(rowCount);
        for (let y = 0; y < rowCount; y++) {
            sliceImages[y] = new Array(colCount);
            for (let x = 0; x < colCount; x++) {
                tempCtx.clearRect(0, 0, pieceSize, pieceSize);
                //å¦‚æœå®½é«˜è¶…å‡ºcanvasåˆ™å‡å°
                let width = (x + 1 * pieceSize) > canvas.width ? canvas.width - x * pieceSize : pieceSize;
                let height = (y + 1 * pieceSize) > canvas.height ? canvas.height - y * pieceSize : pieceSize;
                let imageData = ctx.getImageData(x * pieceSize, y * pieceSize, width, height);
                sliceImages[y][x] = imageData;

                tempCtx.putImageData(imageData, 0, 0);
                tempCtx.fillText((y + 1) + ',' + (x + 1), pieceSize, pieceSize);
                let tempImageURL = tempCanvas.toDataURL("image/png");
                let img = $('#sliceImage-' + y + '_' + x);
                img.attr('src', tempImageURL);
                img.click(function () {
                    showLoadingMask(() => {
                        currentSliceImage = { x: x, y: y };
                        showImageView(sliceImages[y][x]);
                    });
                });
            }
        }
    }

    //ç”Ÿæˆå…¨å›¾çš„é©¬èµ›å…‹è§†å›¾
    function showFullImageView(keepOffset) {
        currentSliceImage = null;
        let imageData = fullCanvas.getContext('2d').getImageData(0, 0, fullCanvas.width, fullCanvas.height);
        showImageView(imageData, fullCanvas.width, fullCanvas.height, keepOffset);
    }

    //ç”ŸæˆæŒ‡å®šå›¾åƒæ•°æ®é©¬èµ›å…‹è§†å›¾
    function showImageView(imageData, keepOffset) {
        //é¦–å…ˆç»˜åˆ¶åœ¨largeCanvasä¸Šï¼Œå†æ ¹æ®åç§»åæ ‡ç»˜åˆ°viewCanvas
        largeCanvas = document.createElement('canvas');
        let largeCtx = largeCanvas.getContext('2d');

        largeCanvas.width = imageData.width * (pixelSize + 1);
        largeCanvas.height = imageData.height * (pixelSize + 1);
        largeCtx.font = (~~(pixelSize / 2)) + 'px monospace';
        largeCtx.strokeStyle = '#000';
        largeCtx.textBaseline = 'middle';
        largeCtx.textAlign = 'center';

        //ç»˜åˆ¶æ ‡å°º
        drawRulers(imageData.width, imageData.height);

        //ç»˜åˆ¶ç½‘æ ¼
        largeCtx.beginPath();
        for (let x = 1; x < imageData.width; x++) {
            largeCtx.moveTo(x * (pixelSize + 1) - 0.5, 0);
            largeCtx.lineTo(x * (pixelSize + 1) - 0.5, largeCanvas.height);
            largeCtx.stroke();
        }
        for (let y = 1; y < imageData.height; y++) {
            largeCtx.moveTo(0, y * (pixelSize + 1) - 0.5);
            largeCtx.lineTo(largeCanvas.width, y * (pixelSize + 1) - 0.5);
            largeCtx.stroke();
        }

        //é€åƒç´ è¯»å–åŸå›¾å¹¶ç»˜åˆ¶å¤§å›¾
        colorSum = new Map();//å¤§å›¾é¢œè‰²ç»Ÿè®¡
        let totolBeadCount = 0;//æ€»æ‹¼è±†æ•°
        for (let i = 0; i < imageData.data.length; i += 4) {

            //è¯»å–é¢œè‰²ï¼Œå¦‚æœé€æ˜åˆ™è·³è¿‡
            let a = imageData.data[i + 3];
            if (a == 0) continue;

            let r = imageData.data[i];
            let g = imageData.data[i + 1];
            let b = imageData.data[i + 2];
            let hex = rgbToHex(r, g, b);

            //è®¡ç®—åæ ‡
            let x = (i / 4) % imageData.width;
            let y = ~~((i / 4) / imageData.width);
            // let realPosition = getRealPosition(x, y);

            totolBeadCount++;

            //ç»˜åˆ¶å¤§åƒç´ å—
            largeCtx.fillStyle = 'rgb(' + r + ',' + g + ',' + b + ')';
            largeCtx.fillRect(x * (pixelSize + 1), y * (pixelSize + 1), pixelSize, pixelSize);

            //å†™æ–‡å­—
            largeCtx.fillStyle = getFontColor(r, g, b);//æµ…è‰²é»‘å­—ï¼Œæ·±è‰²ç™½å­—

            //ç»Ÿè®¡é¢œè‰²æˆ–å‡ºé”™ä¿¡æ¯
            let color = paletteMap.get(hex);
            if (color) {
                if (colorSum.has(hex)) colorSum.set(hex, colorSum.get(hex) + 1);
                else colorSum.set(hex, 1);
            }
            else {
                console.log('Error color: ' + rgbToHex(r, g, b));
                console.log('hex: ' + hex);
                if (colorSum.has('Err')) colorSum.set('Err', colorSum.get('Err') + 1);
                else colorSum.set('Err', 1);
            }
            largeCtx.fillText(color ? color.name : 'Err', x * (pixelSize + 1) + ~~(pixelSize * 0.5), y * (pixelSize + 1) + ~~(pixelSize * 0.5));
        }

        if (!keepOffset) {//ä¿æŒæ‹–æ‹½åç§»é‡ä¸å˜ï¼ˆåˆ·æ–°æ—¶ç”¨ï¼‰
            largeCanvasStartOffsetX = 0, largeCanvasStartOffsetY = 0;
            largeCanvasOffsetX = 0, largeCanvasOffsetY = 0;
        }

        resizeViewCanvasFitWindow();
        //ç»˜åˆ¶éƒ¨åˆ†å›¾åƒåˆ°viewCanvas
        showPartView();

        //æŒ‰é¢œè‰²æ•°é‡é€’å‡æ’åºå¹¶æ˜¾ç¤ºåœ¨é¢œè‰²ç»Ÿè®¡æ¡†
        let colorSumSorted = new Map([...colorSum.entries()].sort(function (a, b) {
            return b[1] - a[1];
        }));
        let sumHtml = '<tr><td>åˆè®¡</td><td>' + totolBeadCount + '</td><td></td></tr>';
        for (let [color, count] of colorSumSorted) {
            try {
                sumHtml += '<tr><td style="background:#' + color + ';color:' + getFontColor(color) + ';">' + paletteMap.get(color).name + '</td><td>' + count + '</td>';
            if (color != 'Err')
                sumHtml += '<td><button type="button" class="btn btn-primary btn-sm filterColor" title="åªæ˜¾ç¤ºæ‰€æœ‰' + paletteMap.get(color).name + '" value=' + color + '>&lt;&lt;</button></td></tr>';
            else
                sumHtml += '<td></td></tr>';
            }catch (e) {
                console(color);
            }
        }
        $('#colorSumTable').html(sumHtml);

        //ç»‘å®šé¢œè‰²ç­›é€‰äº‹ä»¶
        $('.filterColor').on('click tap', function (e) {
            let color = $(this).attr('value');
            if (color && color != 'Err') {
                filterColor = color;
                refreshImage();
            }
        });

        let infoHtml = currentSliceImage ?
            "å›¾å—(" + (currentSliceImage.y + 1) + "," + (currentSliceImage.x + 1) + ") ,(" + pieceSize + "x" + pieceSize + ")"
            : "å…¨å›¾(" + fullCanvas.width + "x" + fullCanvas.height + ")";
        if (filterColor) {
            infoHtml += "(åªæ˜¾ç¤º<div class='colorBlock' style='background:#" + filterColor + ";color:" + getFontColor(filterColor) + ";'>"
                + paletteMap.get(filterColor).name + "</div>, ç‚¹å‡»å¤§å›¾æ˜¾ç¤ºå…¨éƒ¨)";
        }
        //æ˜¾ç¤ºå¤§å›¾æ‘˜è¦è¯´æ˜
        $('#largePicInfo').html(infoHtml);
    }

    //å°†å¤§å›¾çš„ä¸€éƒ¨åˆ†ç»˜åˆ¶åˆ°è§†å›¾
    function showPartView() {
        if (isDrawingViewCanvas) return;

        isDrawingViewCanvas = true;
        let largeCtx = largeCanvas.getContext('2d'),
            viewCtx = viewCanvas.getContext('2d');

        //é‡ç»˜åé‡æ–°è®¡ç®—ä¸€æ¬¡å°ºå¯¸ï¼Œé¿å…æ»šåŠ¨æ¡å½±å“å®½åº¦ï¼Œä½¿canvasçš„widthå’Œå®é™…å®½åº¦ä¸ä¸€è‡´
        viewCanvas.width = viewCanvas.clientWidth, viewCanvas.height = viewCanvas.clientHeight;
        //åˆ‡å›¾æ—¶è¦è®¡ç®—ä¸¤è¾¹çš„æ ‡å°ºé•¿åº¦
        let viewImageData = largeCtx.getImageData(largeCanvasOffsetX, largeCanvasOffsetY, viewCanvas.width - 2 * (pixelSize + 1), viewCanvas.height - 2 * (pixelSize + 1));
        viewCtx.putImageData(viewImageData, pixelSize + 1, pixelSize + 1);
        //æ˜¾ç¤ºå±€éƒ¨æ ‡å°º
        showPartRulers();
        isDrawingViewCanvas = false;
    }

    //ç»˜åˆ¶å®Œæ•´æ ‡å°º
    function drawRulers(width, height) {
        //åˆå§‹åŒ–å››å—æ ‡å°ºç”»å¸ƒ
        rulerX1Canvas = document.createElement('canvas'), rulerX2Canvas = document.createElement('canvas');
        rulerY1Canvas = document.createElement('canvas'), rulerY2Canvas = document.createElement('canvas');
        rulerX1Canvas.width = width * (pixelSize + 1), rulerX1Canvas.height = pixelSize + 1;
        rulerX2Canvas.width = width * (pixelSize + 1), rulerX2Canvas.height = pixelSize + 1;
        rulerY1Canvas.width = pixelSize + 1, rulerY1Canvas.height = height * (pixelSize + 1);
        rulerY2Canvas.width = pixelSize + 1, rulerY2Canvas.height = height * (pixelSize + 1);
        let rulerX1Ctx = rulerX1Canvas.getContext('2d'), rulerX2Ctx = rulerX2Canvas.getContext('2d'),
            rulerY1Ctx = rulerY1Canvas.getContext('2d'), rulerY2Ctx = rulerY2Canvas.getContext('2d');
        rulerX1Ctx.fillStyle = '#000';
        rulerX1Ctx.strokeStyle = '#000';
        rulerX1Ctx.font = (~~(pixelSize / 2) + 2) + 'px monospace';
        rulerX1Ctx.textBaseline = 'middle';
        rulerX1Ctx.textAlign = 'center';
        rulerX2Ctx.fillStyle = '#000';
        rulerX2Ctx.strokeStyle = '#000';
        rulerX2Ctx.font = (~~(pixelSize / 2) + 2) + 'px monospace';
        rulerX2Ctx.textBaseline = 'middle';
        rulerX2Ctx.textAlign = 'center';
        rulerY1Ctx.fillStyle = '#000';
        rulerY1Ctx.strokeStyle = '#000';
        rulerY1Ctx.font = (~~(pixelSize / 2) + 2) + 'px monospace';
        rulerY1Ctx.textBaseline = 'middle';
        rulerY1Ctx.textAlign = 'center';
        rulerY2Ctx.fillStyle = '#000';
        rulerY2Ctx.strokeStyle = '#000';
        rulerY2Ctx.font = (~~(pixelSize / 2) + 2) + 'px monospace';
        rulerY2Ctx.textBaseline = 'middle';
        rulerY2Ctx.textAlign = 'center';

        //æ¨ªåæ ‡ç»˜åˆ¶åŠç«–çº¿å’Œæ–‡å­—
        rulerX1Ctx.beginPath();
        rulerX2Ctx.beginPath();
        for (let x = 0; x <= width; x++) {
            //æ¯”å®é™…å°ºå¯¸å‡0.5åƒç´ æ˜¯ç”±äºcanvasçš„ç»˜å›¾æ–¹å¼ï¼Œé˜²æ­¢å‡ºç°åŠåƒç´ 
            rulerX1Ctx.moveTo(x * (pixelSize + 1) - 0.5, ~~(pixelSize * 0.5) - 0.5);
            rulerX1Ctx.lineTo(x * (pixelSize + 1) - 0.5, pixelSize + 1 - 0.5);
            rulerX1Ctx.stroke();
            rulerX2Ctx.moveTo(x * (pixelSize + 1) - 0.5, - 0.5);
            rulerX2Ctx.lineTo(x * (pixelSize + 1) - 0.5, ~~(pixelSize * 0.5) - 0.5);
            rulerX2Ctx.stroke();
            //ç»˜åˆ¶æ ‡å°ºæ–‡å­—
            if (x < width) {
                rulerX1Ctx.fillText(x + 1, x * (pixelSize + 1) + ~~(pixelSize * 0.5), ~~(pixelSize * 0.5));
                rulerX2Ctx.fillText(x + 1, x * (pixelSize + 1) + ~~(pixelSize * 0.5), ~~(pixelSize * 0.5));
            }
        }
        //çºµåæ ‡ç»˜åˆ¶æ¨ªç«–çº¿å’Œæ–‡å­—
        rulerY1Ctx.beginPath();
        rulerY2Ctx.beginPath();
        for (let y = 0; y <= height; y++) {//æ¨ªçº¿
            rulerY1Ctx.moveTo(~~(pixelSize * 0.5) - 0.5, y * (pixelSize + 1) - 0.5);
            rulerY1Ctx.lineTo(pixelSize + 1 - 0.5, y * (pixelSize + 1) - 0.5);
            rulerY1Ctx.stroke();
            rulerY2Ctx.moveTo(~~(pixelSize * 0.5) - 0.5, y * (pixelSize + 1) - 0.5);
            rulerY2Ctx.lineTo(- 0.5, y * (pixelSize + 1) - 0.5);
            rulerY2Ctx.stroke();
            if (y < height) {
                rulerY1Ctx.fillText(y + 1, ~~(pixelSize * 0.5), y * (pixelSize + 1) + ~~(pixelSize * 0.5));
                rulerY2Ctx.fillText(y + 1, ~~(pixelSize * 0.5), y * (pixelSize + 1) + ~~(pixelSize * 0.5));
            }
        }
    }

    //å°†å®Œæ•´æ ‡å°ºçš„ä¸€éƒ¨åˆ†ç»˜åˆ¶åˆ°è§†å›¾å››è¾¹
    function showPartRulers() {
        let viewCtx = viewCanvas.getContext('2d'),
            rulerX1Ctx = rulerX1Canvas.getContext('2d'), rulerX2Ctx = rulerX2Canvas.getContext('2d'),
            rulerY1Ctx = rulerY1Canvas.getContext('2d'), rulerY2Ctx = rulerY2Canvas.getContext('2d');
        //ç»˜åˆ¶ä¸Šæ¨ªæ ‡å°º
        viewCtx.putImageData(rulerX1Ctx.getImageData(largeCanvasOffsetX, 0, viewCanvas.width - 2 * (pixelSize + 1), pixelSize + 1), pixelSize + 1, 0);
        //ç»˜åˆ¶ä¸‹æ¨ªæ ‡å°º
        viewCtx.putImageData(rulerX2Ctx.getImageData(largeCanvasOffsetX, 0, viewCanvas.width - 2 * (pixelSize + 1), pixelSize + 1), pixelSize + 1, viewCanvas.height - pixelSize - 1);
        //ç»˜åˆ¶å·¦ç«–æ ‡å°º
        viewCtx.putImageData(rulerY1Ctx.getImageData(0, largeCanvasOffsetY, pixelSize + 1, viewCanvas.height - 2 * (pixelSize + 1)), 0, pixelSize + 1);
        //ç»˜åˆ¶å³ç«–æ ‡å°º
        viewCtx.putImageData(rulerY2Ctx.getImageData(0, largeCanvasOffsetY, pixelSize + 1, viewCanvas.height - 2 * (pixelSize + 1)), viewCanvas.width - pixelSize - 1, pixelSize + 1);
        //ç»˜åˆ¶å››æ¡æ ‡å°ºè¾¹çº¿
        viewCtx.beginPath();
        viewCtx.moveTo(0, pixelSize + 1 - 0.5);
        viewCtx.lineTo(viewCanvas.width, pixelSize + 1 - 0.5);
        viewCtx.stroke();
        viewCtx.moveTo(0, viewCanvas.height - (pixelSize + 1) - 0.5);
        viewCtx.lineTo(viewCanvas.width, viewCanvas.height - (pixelSize + 1) - 0.5);
        viewCtx.stroke();
        viewCtx.moveTo(pixelSize + 1 - 0.5, 0);
        viewCtx.lineTo(pixelSize + 1 - 0.5, viewCanvas.height);
        viewCtx.stroke();
        viewCtx.moveTo(viewCanvas.width - (pixelSize + 1) - 0.5, 0);
        viewCtx.lineTo(viewCanvas.width - (pixelSize + 1) - 0.5, viewCanvas.height);
        viewCtx.stroke();
    }

    //åˆ·æ–°å›¾ç‰‡ï¼ˆä¿®æ”¹æ˜¾ç¤ºåƒç´ æˆ–è€…æ›¿æ¢é¢œè‰²ä¹‹åï¼Œä¿æŒå½“å‰è§†è§’ä¸å˜è¿›è¡Œåˆ·æ–°ï¼‰
    function refreshImage() {
        showLoadingMask(() => {
            let ctx = fullCanvas.getContext('2d'),
                newImageData = ctx.createImageData(paletteImageData);//æ–°å»ºä¸€ä»½åŸå°ºå¯¸çš„é€æ˜å›¾å½¢æ•°æ®

            //é€åƒç´ è¯»å–æ›¿æ¢è°ƒè‰²æ¿åçš„åŸå›¾
            for (let i = 0; i < paletteImageData.data.length; i += 4) {
                //å¦‚æœé€æ˜åˆ™è·³è¿‡
                let a = paletteImageData.data[i + 3];
                if (a == 0) continue;

                //è·å–é¢œè‰²å€¼
                let r = paletteImageData.data[i];
                let g = paletteImageData.data[i + 1];
                let b = paletteImageData.data[i + 2];
                let hex = rgbToHex(r, g, b);

                //è®¡ç®—åæ ‡
                let x = (i / 4) % paletteImageData.width;
                let y = ~~((i / 4) / paletteImageData.width);

                //æ£€æŸ¥åƒç´ æ›¿æ¢é¢œè‰²
                if (pixelColorReplaceList.has(x + ',' + y)) {
                    let replaceColor = pixelColorReplaceList.get(x + ',' + y).new;
                    let replaceColorRgb = hexToRgb(replaceColor);
                    hex = replaceColor;
                    r = replaceColorRgb.r;
                    g = replaceColorRgb.g;
                    b = replaceColorRgb.b;
                }
                //æ£€æŸ¥æ›¿æ¢é¢œè‰²
                else if (colorReplaceList.has(hex)) {
                    let replaceColor = colorReplaceList.get(hex);
                    let replaceColorRgb = hexToRgb(replaceColor);
                    hex = replaceColor;
                    r = replaceColorRgb.r;
                    g = replaceColorRgb.g;
                    b = replaceColorRgb.b;
                }

                //å¦‚æœå¯ç”¨è¿‡æ»¤é¢œè‰²åˆ™åªæ˜¾ç¤ºæ­¤é¢œè‰²
                if (filterColor && filterColor != hex) continue;

                //è®¾ç½®æ–°å›¾åƒç´ ç‚¹
                newImageData.data[i] = r;
                newImageData.data[i + 1] = g;
                newImageData.data[i + 2] = b;
                newImageData.data[i + 3] = 255;//å¤„ç†åä¸€å¾‹å˜æˆä¸é€æ˜è‰²
            }

            //ç»˜åˆ¶è¿‡æ»¤æ›¿æ¢åçš„æ–°å›¾
            ctx.putImageData(newImageData, 0, 0);

            //å°†å®Œæ•´å›¾ç‰‡åˆ‡æˆå›¾å—
            sliceCanvasToImage(fullCanvas, 'sliceImageContainer');

            //æ ¹æ®å½“å‰æ˜¾ç¤ºçš„æ˜¯å…¨å›¾æˆ–å›¾å—æ˜¾ç¤ºè§†å›¾
            if (!currentSliceImage) {
                showFullImageView(true);
            }
            else {
                //å¦‚æœä¿®æ”¹å›¾å—å¤§å°å¯¼è‡´å›¾å—ä¸‹æ ‡è¶Šç•Œåˆ™å½’é›¶
                if (currentSliceImage.y >= sliceImages.length) currentSliceImage.y = 0;
                if (currentSliceImage.x >= sliceImages[0].length) currentSliceImage.x = 0;
                showImageView(sliceImages[currentSliceImage.y][currentSliceImage.x], pieceSize, pieceSize, true);
            }
        });
    }

    //åˆ·æ–°é¢œè‰²æ›¿æ¢åˆ—è¡¨
    function refreshColorReplaceList() {
        let pixelColorReplaceHtml = '';
        for (let [position, colors] of pixelColorReplaceList) {
            //åŸä½ç½®åæ ‡ä¸ºæ•°ç»„ä¸‹æ ‡ï¼Œéœ€è¦å„è‡ª+1åæ˜¾ç¤º
            let positions = position.split(',');
            let positionText = (parseInt(positions[0]) + 1) + ',' + (parseInt(positions[1]) + 1);

            pixelColorReplaceHtml += '<tr><td>' + positionText + '</td>';
            pixelColorReplaceHtml += '<td style="background:#' + colors.old + ';color:' + getFontColor(colors.old) + ';">' + paletteMap.get(colors.old).name + '</td>';
            pixelColorReplaceHtml += '<td style="background:#' + colors.new + ';color:' + getFontColor(colors.new) + ';">' + paletteMap.get(colors.new).name + '</td>';
            pixelColorReplaceHtml += '<td><button type="button" class="btn btn-danger btn-sm remove-pixel-color-replace" value=' + position + '>åˆ é™¤</button></td></tr>';
        }
        $('#pixelColorReplaceTable').html(pixelColorReplaceHtml);

        let colorReplaceHtml = '';
        for (let [oldColor, newColor] of colorReplaceList) {
            colorReplaceHtml += '<tr><td style="background:#' + oldColor + ';color:' + getFontColor(oldColor) + ';">' + paletteMap.get(oldColor).name + '</td>';
            colorReplaceHtml += '<td style="background:#' + newColor + ';color:' + getFontColor(newColor) + ';">' + paletteMap.get(newColor).name + '</td>';
            colorReplaceHtml += '<td><button type="button" class="btn btn-danger btn-sm remove-color-replace" value=' + oldColor + '>åˆ é™¤</button></td></tr>';
        }
        $('#colorReplaceTable').html(colorReplaceHtml);

        //ç»‘å®šåˆ é™¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        $(".remove-color-replace").on('click tap', function () {
            let color = $(this).attr('value');
            if (colorReplaceList.has(color)) {
                colorReplaceList.delete(color);
                refreshColorReplaceList();
                refreshImage();
            }
        });
        $(".remove-pixel-color-replace").on('click tap', function () {
            let position = $(this).attr('value');
            if (pixelColorReplaceList.has(position)) {
                pixelColorReplaceList.delete(position);
                refreshColorReplaceList();
                refreshImage();
            }
        });
    }

    //æ›¿æ¢é¢œè‰²
    function replaceColor(fromColor, toColor) {
        colorReplaceList.set(fromColor, toColor);//æ·»åŠ æˆ–æ›´æ–°æ›¿æ¢è§„åˆ™
        //éå†æ›¿æ¢åˆ—è¡¨ï¼Œå°†åŸå…ˆç›®æ ‡é¢œè‰²ä¸ºfromColorçš„ä¹Ÿæ¢æˆtoColor
        for (let [oldColor, newColor] of colorReplaceList) {
            if (newColor == fromColor) colorReplaceList.set(oldColor, toColor);
        }
        //éå†åƒç´ æ›¿æ¢åˆ—è¡¨ï¼Œå°†åŸå…ˆç›®æ ‡é¢œè‰²ä¸ºfromColorçš„ä¹Ÿæ¢æˆtoColor
        for (let [position, colors] of pixelColorReplaceList) {
            if (colors.new == fromColor) pixelColorReplaceList.set(position, { old: colors.old, new: toColor });
        }
    }

    //æ›¿æ¢åƒç´ é¢œè‰²
    function replacePixelColor(x, y, toColor) {
        let position = x + ',' + y;
        if (pixelColorReplaceList.has(position)) {
            pixelColorReplaceList.get(position).new = toColor;//å¦‚æœå·²å­˜åœ¨æ­¤åƒç´ è§„åˆ™ï¼Œåªä¿®æ”¹æ–°é¢œè‰²ï¼Œä¸ä¿®æ”¹åŸå§‹é¢œè‰²è®°å½•
        }
        else {
            let oldColor = getFullImageColor(x, y);
            pixelColorReplaceList.set(position, { old: oldColor, new: toColor });
        }
    }

    //ä½¿ç”¨åˆ‡å—åæ ‡è·å–åœ¨å…¨å›¾ä¸­çš„çœŸå®åæ ‡
    function getRealPosition(x, y) {
        //å¦‚æœæ˜¾ç¤ºçš„æ˜¯å…¨å›¾åˆ™ç›´æ¥è¿”å›åŸå§‹åæ ‡
        if (!currentSliceImage) {
            return { x: x, y: y };
        }
        //å¦åˆ™æ ¹æ®åˆ‡å—ä½ç½®è®¡ç®—çœŸå®åæ ‡
        else {
            return {
                x: x + currentSliceImage.x * pieceSize,
                y: y + currentSliceImage.y * pieceSize
            };
        }
    }

    //ä½¿ç”¨çœŸå®åæ ‡è·å–åœ¨åˆ‡å—ä¸­çš„åæ ‡
    function getSlicePosition(x, y) {
        //å¦‚æœæ˜¾ç¤ºçš„æ˜¯å…¨å›¾åˆ™ç›´æ¥è¿”å›åŸå§‹åæ ‡
        if (!currentSliceImage) {
            return { x: x, y: y };
        }
        //å¦åˆ™é€šè¿‡çœŸå®åæ ‡è®¡ç®—å½“å‰åˆ‡å—ä¸­çš„åæ ‡
        else {
            return {
                x: x - currentSliceImage.x * pieceSize,
                y: y - currentSliceImage.y * pieceSize
            };
        }
    }

    //å¯»æ‰¾ä¸€ä¸ªé¢œè‰²æœ€ç›¸è¿‘çš„è°ƒè‰²æ¿è‰²å€¼
    function findSimilarColor(r, g, b) {
        // ä½¿ç”¨ç¼“å­˜åŠ é€Ÿ
        let hex = rgbToHex(r, g, b);
        if (similarColorCache.has(hex)) {
            return similarColorCache.get(hex);
        }

        let minDistance = Infinity;
        let minColor = null;

        // æŒ‰æ‰€é€‰åŒ¹é…æ¨¡å‹è®¡ç®—è·ç¦»
        for (let color of paletteMap.values()) {
            let distance;
            if (colorMatchModel == 'rgb') {
                distance = colorRGBDistance(color.r, color.g, color.b, r, g, b);
            } else if (colorMatchModel == 'lab') {
                // åœ¨ Lab ç©ºé—´ä¸­æ¯”è¾ƒï¼ˆæ›´æ¥è¿‘äººçœ¼æ„ŸçŸ¥ï¼‰
                let labTarget = rgbToLab(r, g, b);
                let labPalette = rgbToLab(color.r, color.g, color.b);
                distance = colorLabDistanceObjects(labTarget, labPalette);
            } else if (colorMatchModel == 'hsv') {
                distance = colorHSVDistance(color.r, color.g, color.b, r, g, b);
            } else {
                distance = colorCIEDEDistance(color.r, color.g, color.b, r, g, b);
            }

            if (distance == 0) {
                similarColorCache.set(hex, color);
                return color;
            }

            if (distance < minDistance) {
                minDistance = distance;
                minColor = color;
            }
        }

        similarColorCache.set(hex, minColor);
        return minColor;
    }


    // //å¯»æ‰¾ä¸€ä¸ªé¢œè‰²æœ€ç›¸è¿‘çš„è°ƒè‰²æ¿è‰²å€¼
    // function findSimilarColor(r, g, b) {
    //     let hex = rgbToHex(r, g, b);
    //     //é¦–å…ˆæŸ¥æ‰¾ç¼“å­˜
    //     if (similarColorCache.has(hex)) {
    //         return similarColorCache.get(hex);
    //     }
    //     let LabTarget = rgbToLab(r, g, b);
    //     let minDistance = Infinity;
    //     let closestColor = null;
    //
    //     for (let color of paletteMap.values()) {
    //
    //         let LabPalette = rgbToLab(color.r, color.g, color.b);
    //         let distance = colorLabDistance(LabTarget, LabPalette);
    //         if (distance < minDistance) {
    //             minDistance = distance;
    //             closestColor = color;
    //         }
    //     }
    //
    //     return closestColor;
    // }

    //è°ƒè‰²æ¿æ•°æ®ç”ŸæˆåŠ¨æ€å¯¹è±¡ä»¥ä¾¿æŸ¥è¯¢
    function generatePaletteMap(palette) {
        let map = new Map();
        for (let i = 0; i < palette.length; i++) {
            let rgb = hexToRgb(palette[i].color);
            map.set(palette[i].color, {
                name: palette[i].name,
                r: rgb.r,
                g: rgb.g,
                b: rgb.b
            });
        }
        return map;
    }

    //ç”Ÿæˆè°ƒè‰²æ¿é€‰è‰²å—çš„HTMLä»£ç 
    function generateColorSelectorHtml() {
        let colorSelectorHtml = '';
        for (let color of paletteMap.values()) {
            let fontColor = getFontColor(color.r, color.g, color.b);
            let hex = rgbToHex(color.r, color.g, color.b);
            colorSelectorHtml += "<div class='colorBlock pointer' style='background:#" + hex + ";color:" + fontColor + ";' color='" + hex + "' title='#" + hex + "'>" + color.name + "</div>";
        }
        $('#colorSelector').html(colorSelectorHtml);

        //é€‰è‰²å—ç‚¹å‡»äº‹ä»¶
        $('#colorSelector>div').on('click tap', function (e) {
            $('#colorSelector>div.selected').removeClass('selected');
            $(this).addClass('selected');
            //ä¿®æ”¹æŒ‰é’®æ ‡ç­¾
            $('#replaceColor').html('æ‰€æœ‰' + selectedPixel.name + 'æ¢æˆ' + $(this).html());
            $('#replacePixel').html('æ­¤åƒç´ æ¢æˆ' + $(this).html());
            $('#replacePixelBrush').html('ä½¿ç”¨' + $(this).html() + 'ç¬”åˆ·');
            $('#colorToolBar').css('visibility', 'visible');

            $('#replacePixel').val($(this).attr('color'));
            $('#replaceColor').val($(this).attr('color'));
            $('#replacePixelBrush').val($(this).attr('color'));
        });
    }

    //åå…­è¿›åˆ¶é¢œè‰²è½¬rgbæ•°å€¼
    function hexToRgb(hex) {
        let result = /^([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result ? {
            r: parseInt(result[1], 16),
            g: parseInt(result[2], 16),
            b: parseInt(result[3], 16),
        } : null;
    }

    //rgbæ•°å€¼è½¬åå…­è¿›åˆ¶é¢œè‰²
    function rgbToHex(r, g, b) {
        let rhex = r.toString(16),
            ghex = g.toString(16),
            bhex = b.toString(16);
        return (rhex.length == 1 ? "0" + rhex : rhex) + (ghex.length == 1 ? "0" + ghex : ghex) + (bhex.length == 1 ? "0" + bhex : bhex);
    }

    //æ ¹æ®èƒŒæ™¯é¢œè‰²è·å–å¯è§†çš„å­—ä½“é¢œè‰²ï¼ˆä¼ å…¥rgbæˆ–16è¿›åˆ¶é¢œè‰²å‡å¯ï¼Œè¿”å›16è¿›åˆ¶é¢œè‰²ï¼‰
    function getFontColor(arg1, arg2, arg3) {
        if (typeof arg1 == 'string' && arg1.length == 6) {
            let rgb = hexToRgb(arg1);
            return rgb.r + rgb.g + rgb.b > 384 ? '#000' : '#FFF';//æµ…è‰²é»‘å­—ï¼Œæ·±è‰²ç™½å­—
        } else if (typeof arg1 == 'number' && typeof arg2 == 'number' && typeof arg2 == 'number') {
            return arg1 + arg2 + arg2 > 384 ? '#000' : '#FFF';
        }
        else
            return null;
    }

    function rgbToLab(r, g, b) {
        // RGBè½¬sRGB
        r /= 255; g /= 255; b /= 255;
        r = r > 0.04045 ? Math.pow((r + 0.055) / 1.055, 2.4) : r / 12.92;
        g = g > 0.04045 ? Math.pow((g + 0.055) / 1.055, 2.4) : g / 12.92;
        b = b > 0.04045 ? Math.pow((b + 0.055) / 1.055, 2.4) : b / 12.92;

        // sRGBè½¬XYZ
        const x = (r * 0.4124564 + g * 0.3575761 + b * 0.1804375) / 0.95047;
        const y = (r * 0.2126729 + g * 0.7151522 + b * 0.0721750) / 1.00000;
        const z = (r * 0.0193339 + g * 0.1191920 + b * 0.9503041) / 1.08883;

        // XYZè½¬LAB
        const xyz = [x, y, z].map(v => v > 0.008856 ? Math.pow(v, 1/3) : (7.787 * v) + 16/116);
        return {L: (116 * xyz[1]) - 16, a: 500 * (xyz[0] - xyz[1]), b: 200 * (xyz[1] - xyz[2])};
    }

    function rgbToHSV(r, g, b) {
        // å°†RGBå€¼æ ‡å‡†åŒ–åˆ°0-1èŒƒå›´
        R = r / 255;
        G = g / 255;
        B = b / 255;
        // è®¡ç®—HSVå€¼
        let max = Math.max(R, G, B);
        let min = Math.min(R, G, B);
        let delta = max - min;
        let H, S, V;

        V = max; // HSVçš„Vé€šé“

        if (delta === 0) {
            H = 0; // ç°è‰²ï¼Œæ²¡æœ‰è‰²ç›¸
        } else {
            if (max === R) {
                H = 60 * (((G - B) / delta) % 6);
            } else if (max === G) {
                H = 60 * (((B - R) / delta) + 2);
            } else {
                H = 60 * (((R - G) / delta) + 4);
            }
            if (H < 0) {
                H += 360;
            }
        }

        S = max === 0 ? 0 : delta / max;
        return {H: H, S:S, V:V};
    }

    function colorLabDistanceObjects(Lab1, Lab2) {

        const dL = Lab1.L - Lab2.L;
        const da = Lab1.a - Lab2.a;
        const db = Lab1.b - Lab2.b;

        return Math.sqrt(dL * dL + da * da + db * db);
    }

    // [æµ·ç›ç‡ˆç‰ˆæœ¬]
    // function colorDistance(r1, g1, b1, r2, g2, b2) {
    //     const Lab1 = rgbToLab(r1, g1, b1);
    //     const Lab2 = rgbToLab(r2, g2, b2);
    //
    //     const dL = Lab1.L - Lab2.L;
    //     const da = Lab1.a - Lab2.a;
    //     const db = Lab1.b - Lab2.b;
    //
    //     return Math.sqrt(dL * dL + da * da + db * db);
    // }


    //[æœ€åˆç‰ˆæœ¬]é¢œè‰²å·®åˆ«å…¬å¼ï¼Œç®€åŒ–ç‰ˆï¼Œå‚è€ƒhttps://stackoverflow.com/a/9085524
    function colorRGBDistance(r1, g1, b1, r2, g2, b2) {
        let rmean = (r1 + r2) / 2,
            rd = r1 - r2,
            gd = g1 - g2,
            bd = b1 - b2;
        return (((512 + rmean) * rd * rd) >> 8) + 4 * gd * gd + (((767 - rmean) * bd * bd) >> 8);
    }

    //[LABé¢œè‰²ç©ºé—´]
    function colorLabDistance(r1, g1, b1, r2, g2, b2) {
        let rmean = (r1 + r2) / 2,
            rd = r1 - r2,
            gd = g1 - g2,
            bd = b1 - b2;
        return Math.sqrt((2 + rmean / 256) * (rd * rd) + 4 * (gd * gd) + (2 + (255 - rmean) / 256) * (bd * bd));
    }

    // [HSVé¢œè‰²ç©ºé—´]
    function colorHSVDistance(r1, g1, b1, r2, g2, b2) {
        let H_1=rgbToHSV(r1,g1,b1).H;
        let S_1=rgbToHSV(r1,g1,b1).S;
        let V_1=rgbToHSV(r1,g1,b1).V;
        let H_2=rgbToHSV(r2,g2,b2).H;
        let S_2=rgbToHSV(r2,g2,b2).S;
        let V_2=rgbToHSV(r2,g2,b2).V;

        // è®¡ç®—é¢œè‰²å·®å¼‚
        let R = 100;
        let angle = 30;
        let h = R * Math.cos(angle / 180 * Math.PI);
        let r = R * Math.sin(angle / 180 * Math.PI);
        let x1 = r * V_1 * S_1 * Math.cos(H_1 / 180 * Math.PI);
        let y1 = r * V_1 * S_1 * Math.sin(H_1 / 180 * Math.PI);
        let z1 = h * (1 - V_1);
        let x2 = r * V_2 * S_2 * Math.cos(H_2 / 180 * Math.PI);
        let y2 = r * V_2 * S_2 * Math.sin(H_2 / 180 * Math.PI);
        let z2 = h * (1 - V_2);
        let dx = x1 - x2;
        let dy = y1 - y2;
        let dz = z1 - z2;
        return Math.sqrt(dx * dx + dy * dy + dz * dz);

    }

    // é¢œè‰²å·®åˆ«å…¬å¼:CIEDE2000
    function colorCIEDEDistance(r1, g1, bb1, r2, g2, bb2) {
        let lab1 = rgbToLab(r1, g1, bb1);
        let lab2 = rgbToLab(r2, g2, bb2);

        let L1 = lab1.L, a1 = lab1.a, b1 = lab1.b;
        let L2 = lab2.L, a2 = lab2.a, b2 = lab2.b;

        let C1 = Math.sqrt(a1 * a1 + b1 * b1);
        let C2 = Math.sqrt(a2 * a2 + b2 * b2);
        let C = (C1 + C2) / 2;
        let deltaC = C1 - C2;

        let aMean = (a1 + a2) / 2;
        let bMean = (b1 + b2) / 2;
        let deltaH = Math.sqrt((deltaC * deltaC) + (a1 - a2) * (a1 - a2) - (b1 - b2) * (b1 - b2));

        let LPrime = (L1 + L2) / 2;
        let CPrime = C;
        let hPrime1 = Math.atan2(b1, a1);
        let hPrime2 = Math.atan2(b2, a2);

        let T = 1 - 0.17 * Math.cos(Math.PI * hPrime1) + 0.24 * Math.cos(2 * Math.PI * hPrime1) + 0.32 * Math.cos(3 * Math.PI * hPrime1) - 0.20 * Math.cos(4 * Math.PI * hPrime1);
        let S = 1 + 0.015 * CPrime * T;
        let S_L = 1 + 0.045 * (LPrime - 50);

        let deltaTheta = Math.PI * (30 * Math.exp(-((aMean + 175) / 25) * ((aMean + 175) / 25)));
        let RC = -2 * Math.sqrt(Math.pow(CPrime, 7) / Math.pow((CPrime + 571729), 2));
        let RT = -RC * Math.sin(2 * deltaTheta);

        return Math.sqrt((LPrime - L2) * (LPrime - L2) * S_L * S_L + deltaC * deltaC * S * S + deltaH * deltaH * RC * RC + LPrime - L2 + RT);
    }


    //ä½¿canvasçš„å°ºå¯¸ä¸å±å¹•å¤§å°ä¸€è‡´å¹¶ä¸”ä¸è¶…è¿‡å½“å‰å¤§å›¾å°ºå¯¸
    function resizeViewCanvasFitWindow() {
        if (!currentSliceImage) {//ä½¿ç”¨å®Œæ•´å›¾çš„å°ºå¯¸
            viewCanvas.width = Math.min($(window).width() - scrollbarWidth - 4, (originalCanvas.width + 2) * (pixelSize + 1));
            viewCanvas.height = Math.min($(window).height() - 8, (originalCanvas.height + 2) * (pixelSize + 1));
        }
        else//ä½¿ç”¨å•ä¸ªå›¾å—çš„å°ºå¯¸
        {
            viewCanvas.width = Math.min($(window).width() - scrollbarWidth - 4, (pieceSize + 2) * (pixelSize + 1));
            viewCanvas.height = Math.min($(window).height() - 8, (pieceSize + 2) * (pixelSize + 1));
        }
    }

    //è·å–æ»šåŠ¨æ¡å®½åº¦
    function getScrollbarWidth() {
        // Creating invisible container
        const outer = document.createElement('div');
        outer.style.visibility = 'hidden';
        outer.style.overflow = 'scroll'; // forcing scrollbar to appear
        outer.style.msOverflowStyle = 'scrollbar'; // needed for WinJS apps
        document.body.appendChild(outer);

        // Creating inner element and placing it in the container
        const inner = document.createElement('div');
        outer.appendChild(inner);

        // Calculating difference between container's full width and the child width
        const scrollbarWidth = (outer.offsetWidth - inner.offsetWidth);

        // Removing temporary elements from the DOM
        outer.parentNode.removeChild(outer);

        return scrollbarWidth;
    }

    //æ˜¾ç¤ºé®ç½©å¹¶æ‰§è¡Œä»£ç ï¼Œæ‰§è¡Œå®Œåéšè—é®ç½©
    function showLoadingMask(method) {
        if (method) {
            $('#loadingMask').one('show.bs.modal', function (e) {
                setTimeout(() => {
                    method();
                    $('#loadingMask').modal('hide');
                }, 100);
            });
            $('#loadingMask').modal('show');
        }
    }
</script>

</html>